<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Celo Engage Hub</title>
    <style>
        /* ... (Senin CSS'inin tamamı korundu) ... */
        /* Ek olarak modal stilleri eklendi */
        .wallet-modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 9999; }
        .wallet-modal { background: #fff; width: 420px; max-width: calc(100% - 40px); border-radius: 28px; padding: 18px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); border: 1px solid rgba(0,0,0,0.08); }
        .wallet-modal h3 { text-align: center; margin: 6px 0 12px 0; }
        .wallet-option { display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px; border-radius:12px; cursor:pointer; transition:all .18s ease; }
        .wallet-option:hover { transform: translateX(4px); background: #f7f7f8; }
        .wallet-left { display:flex; align-items:center; gap:12px; }
        .wallet-icon { width:44px; height:44px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:20px; background: #f2f2f2; }
        .wallet-meta { display:flex; flex-direction:column; }
        .wallet-name { font-weight:700; }
        .modal-close { position:absolute; right:30px; top:22px; cursor:pointer; font-weight:bold; color:#999; }
        .wallet-list { display:flex; flex-direction:column; gap:8px; margin-top:6px; }
        @media (max-width: 720px) {
            .wallet-modal { width: 92%; }
        }
    </style>
</head>
<body>
    <div class="centered-content">
        <header>
            <div>🌐 Celo Engage Hub</div>
        </header>
        <div class="slogan"> Social TX - Where Every Interaction Builds Real Value </div>
        <div class="subheader">If you want support, support first</div>
        <button id="connectWalletBtn" class="connect-btn">🔗 Connect Wallet</button>
    </div>

    <!-- Connect wallet modal -->
    <div id="walletModalBackdrop" class="wallet-modal-backdrop" aria-hidden="true">
        <div class="wallet-modal" role="dialog" aria-modal="true" aria-labelledby="connectWalletTitle">
            <div style="position:relative;">
                <div id="modalClose" class="modal-close">✖</div>
                <h3 id="connectWalletTitle">Connect Wallet</h3>
            </div>
            <div class="wallet-list">
                <div class="wallet-option" onclick="connectWithWallet('metamask')">
                    <div class="wallet-left">
                        <div class="wallet-icon">🦊</div>
                        <div class="wallet-meta">
                            <div class="wallet-name">MetaMask</div>
                        </div>
                    </div>
                    <div style="font-size:13px; color:#666;">Browser extension</div>
                </div>
                <div class="wallet-option" onclick="connectWithWallet('walletconnect')">
                    <div class="wallet-left">
                        <div class="wallet-icon">🔗</div>
                        <div class="wallet-meta">
                            <div class="wallet-name">WalletConnect</div>
                        </div>
                    </div>
                    <div style="font-size:13px; color:#666;">TrustWallet, Rainbow, Coinbase Mobile, Rabby...</div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="sidebar">
            <div id="walletInfo" class="wallet-address hidden">
                ✅ Connected: <span id="walletAddress"></span>
                <div id="networkInfo" style="font-size: 12px; margin-top: 5px;"></div>
                <div style="margin-top:10px;">
                    <button id="disconnectBtn" style="background:#ef4444;color:white;padding:10px 12px;border-radius:8px;">Disconnect Wallet</button>
                </div>
            </div>
            <!-- ... ecosystem links ... -->
            <!-- ... stats ... -->
        </div>
        <div class="main-content">
            <div class="content-layout">
                <!-- USER PROFILE SECTION -->
                <div id="userProfileSection" class="hidden">
                    <div class="step-indicator">
                        <span class="step-number">👤</span> Your Profile
                    </div>
                    <div class="submit-form">
                        <h3>🆔 Setup Your Profile</h3>
                        <input type="text" placeholder="Enter your username..." id="userUsername" />
                        <div class="gas-info"> ⛽ Setup your profile to unlock all features </div>
                        <button id="setupProfileBtn">🚀 Setup Profile</button>
                    </div>
                </div>
                <!-- SUBMIT YOUR LINK SECTION -->
                <div id="step2" class="submit-section hidden">
                    <div class="step-indicator">
                        <span class="step-number">2</span> Submit Your Link
                    </div>
                    <div class="success-message"> ✅ Thank you for supporting! Now you can submit your own link </div>
                    <div id="networkWarning" class="network-warning hidden"> ⚠️ Please switch to Celo Mainnet to submit your link </div>
                    <div class="submit-form">
                        <h3>🎉 Add Your Content</h3>
                        <input type="text" placeholder="Paste your X, Farcaster, GitHub, or any other link here..." id="userLinkInput" />
                        <br>
                        <div class="gas-info"> ⛽ You'll only pay the normal network gas fee (no extra cost) </div>
                        <button id="submitLinkBtn">✍️ Submit Link</button>
                        <p><small>🔒 Secure transaction on Celo network</small></p>
                    </div>
                </div>
                <!-- SUPPORT COMMUNITY SECTION -->
                <div id="step1" class="support-section">
                    <div class="step-indicator">
                        <span class="step-number">1</span> Support Community Members
                    </div>
                    <div class="step-container">
                        <h3>📋 Support Others First</h3>
                        <p>To submit your link, you must first support at least one community member</p>
                        <div class="links-grid" id="linksContainer"> </div>
                    </div>
                </div>
                <!-- ... governance & badges ... -->
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.7.8/dist/umd/index.min.js"></script>
    <script>
        // State
        let provider = null, rawProvider = null, signer = null, isConnected = false, userAddress = '', hasSupported = false, userProfile = null, currentChainId = null;
        const CONTRACT_ADDRESS = "0x22eA49c074098931a478F381f971C77486d185b2";
        const CONTRACT_ABI = [
            "function registerUser(string memory _username, string memory _link) public",
            "function updateProfile(string memory _username, string memory _link) public",
            "function getUserProfile(address _user) public view returns (string memory link, string memory username, uint256 supportCount, uint256 reputation, uint256 badgeCount, bool isActive, uint256 timestamp)",
        ];
        const CELO_MAINNET_PARAMS = {
            chainId: "0xA4EC", chainName: "Celo Mainnet",
            nativeCurrency: { name: "CELO", symbol: "CELO", decimals: 18 },
            rpcUrls: ["https://forno.celo.org"], blockExplorerUrls: ["https://celoscan.io/"]
        };
        const CELO_ALFAJORES_PARAMS = {
            chainId: "0xAEF3", chainName: "Celo Alfajores Testnet",
            nativeCurrency: { name: "CELO", symbol: "CELO", decimals: 18 },
            rpcUrls: ["https://alfajores-forno.celo-testnet.org"], blockExplorerUrls: ["https://alfajores.celoscan.io/"]
        };
        const initialSupportLinks = [
            "https://farcaster.xyz/teberen/0x391c5713","https://farcaster.xyz/ertu","https://farcaster.xyz/ratmubaba",
            "https://x.com/erturulsezar13?s=21&t=l2lmnRZcmeoUCu9IdzeRpA","https://x.com/egldmvx?s=21&t=l2lmnRZcmeoUCu9IdzeRpA",
            "https://tebberen.github.io/celo-engage-hub/","https://x.com/meelioodas?s=21&t=l2lmnRZcmeoUCu9IdzeRpA",
            "https://x.com/luckyfromnecef/status/1972371920290259437?s=46&t=l2lmnRZcmeoUCu9IdzeRpA","https://github.com/tebberen"
        ];
        function loadLinksFromStorage() {
            const stored = localStorage.getItem('celoEngageHubLinks');
            if (stored) return JSON.parse(stored);
            return initialSupportLinks.map(link => ({ link, clickCount: 0, timestamp: Date.now(), submitter: "community" }));
        }
        function saveLinksToStorage(links) {
            localStorage.setItem('celoEngageHubLinks', JSON.stringify(links));
        }
        let allCommunityLinks = loadLinksFromStorage();
        function getPlatformName(url) {
            if (url.includes('x.com') || url.includes('twitter.com')) return '🐦 X';
            if (url.includes('farcaster.xyz') || url.includes('warpcast.com')) return '🔮 Farcaster';
            if (url.includes('github.com')) return '💻 GitHub';
            if (url.includes('youtube.com')) return '📺 YouTube';
            if (url.includes('discord.com')) return '💬 Discord';
            return '🌐 Website';
        }
        // Support links: NO support button, just clickable links
        function displaySupportLinks() {
            const container = document.getElementById('linksContainer');
            container.innerHTML = '';
            const activeLinks = allCommunityLinks.filter(l => l.clickCount < 9999);
            if (activeLinks.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1 / -1;">
                        <div class="link-card">
                            <p>🌟 No links yet. Submit new links to continue.</p>
                        </div>
                    </div>`;
                return;
            }
            activeLinks.forEach(linkData => {
                const platform = getPlatformName(linkData.link);
                const div = document.createElement('div');
                div.className = 'link-card';
                div.innerHTML = `
                    <div>
                        <div class="link-platform">${platform}</div>
                        <a href="${linkData.link}" target="_blank" class="support-link" onclick="handleLinkClick(event, '${linkData.link}')">
                            ${linkData.link}
                        </a>
                    </div>
                    <div class="link-stats">
                        <div class="stat-item">
                            <div>Supports</div>
                            <div class="stat-value">${linkData.clickCount}</div>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }
        // Link click: open in new tab, show submit section
        function handleLinkClick(event, linkUrl) {
            window.open(linkUrl, '_blank');
            hasSupported = true;
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.remove('hidden');
        }
        // Disconnect
        async function disconnectWallet() {
            try {
                if (rawProvider && rawProvider.disconnect && typeof rawProvider.disconnect === 'function') {
                    try { await rawProvider.disconnect(); } catch (e) { }
                }
            } catch (err) { }
            provider = null; rawProvider = null; signer = null; isConnected = false; userAddress = '';
            document.getElementById('walletInfo').classList.add('hidden');
            document.getElementById('connectWalletBtn').style.display = 'inline-block';
            document.getElementById('userProfileSection').classList.add('hidden');
            document.getElementById('step1').classList.remove('hidden');
            document.getElementById('step2').classList.add('hidden');
        }
        // Connect Modal Logic
        const walletModalBackdrop = document.getElementById('walletModalBackdrop');
        const connectBtn = document.getElementById('connectWalletBtn');
        const modalClose = document.getElementById('modalClose');
        const disconnectBtn = document.getElementById('disconnectBtn');
        connectBtn.addEventListener('click', () => { openWalletModal(); });
        modalClose.addEventListener('click', closeWalletModal);
        walletModalBackdrop.addEventListener('click', (e) => { if (e.target === walletModalBackdrop) closeWalletModal(); });
        disconnectBtn.addEventListener('click', () => { disconnectWallet(); });
        function openWalletModal() { walletModalBackdrop.style.display = 'flex'; walletModalBackdrop.setAttribute('aria-hidden', 'false'); }
        function closeWalletModal() { walletModalBackdrop.style.display = 'none'; walletModalBackdrop.setAttribute('aria-hidden', 'true'); }
        function showConnectModalAndWait() {
            return new Promise((resolve) => {
                openWalletModal();
                const cleanup = () => { document.removeEventListener('walletConnectedTemp', onConnected); };
                function onConnected() { cleanup(); resolve(true); }
                document.addEventListener('walletConnectedTemp', onConnected);
                const observer = new MutationObserver(() => {
                    if (walletModalBackdrop.style.display === 'none') {
                        setTimeout(() => { if (!isConnected) { cleanup(); resolve(false); } }, 200);
                        observer.disconnect();
                    }
                });
                observer.observe(walletModalBackdrop, { attributes: true, attributeFilter: ['style'] });
            });
        }
        async function connectWithWallet(method) {
            closeWalletModal();
            try {
                if (method === 'metamask') {
                    if (!window.ethereum) {
                        const url = 'https://metamask.io/download/';
                        if (confirm("MetaMask not detected. Open MetaMask download page?")) window.open(url, '_blank');
                        return;
                    }
                    rawProvider = window.ethereum;
                    provider = new ethers.providers.Web3Provider(rawProvider);
                    await rawProvider.request({ method: 'eth_requestAccounts' });
                    signer = provider.getSigner();
                } else if (method === 'walletconnect') {
                    const WalletConnectProvider = window.WalletConnectProvider.default || window.WalletConnectProvider;
                    const wcProvider = new WalletConnectProvider({
                        rpc: {
                            42220: 'https://forno.celo.org',
                            44787: 'https://alfajores-forno.celo-testnet.org'
                        },
                        chainId: 42220
                    });
                    await wcProvider.enable();
                    rawProvider = wcProvider;
                    provider = new ethers.providers.Web3Provider(wcProvider);
                    signer = provider.getSigner();
                    wcProvider.on("disconnect", (code, reason) => { disconnectWallet(); });
                } else {
                    await connectWithWallet('walletconnect');
                    return;
                }
                userAddress = await signer.getAddress();
                isConnected = true;
                document.getElementById('walletAddress').textContent = `${userAddress.substring(0,6)}...${userAddress.substring(userAddress.length - 4)}`;
                document.getElementById('walletInfo').classList.remove('hidden');
                document.getElementById('connectWalletBtn').style.display = 'none';
                document.dispatchEvent(new Event('walletConnectedTemp'));
            } catch (err) {
                if (err && err.code === 4001) alert("❌ Connection request rejected");
                else alert("❌ Connection failed: " + (err.message || err));
            }
        }
        // Setup user profile - sadece kullanıcı adı
        async function setupUserProfile() {
            if (!isConnected) {
                const ok = await showConnectModalAndWait();
                if (!ok) return;
            }
            const username = document.getElementById('userUsername').value.trim();
            if (!username) {
                alert("❌ Please enter a username");
                return;
            }
            try {
                document.getElementById("setupProfileBtn").disabled = true;
                document.getElementById("setupProfileBtn").textContent = "⏳ Processing...";
                const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);
                const existing = await contract.getUserProfile(userAddress);
                let tx;
                if (existing.isActive) {
                    tx = await contract.connect(signer).updateProfile(username, "", { gasLimit: 300000 });
                } else {
                    tx = await contract.connect(signer).registerUser(username, "", { gasLimit: 500000 });
                }
                alert(`⏳ Transaction submitted\nTX: ${tx.hash}`);
                await tx.wait();
                alert("✅ Profile setup success!");
                document.getElementById('userProfileSection').classList.add('hidden');
            } catch (err) {
                if (err.code === 4001) alert("❌ Transaction rejected by user");
                else alert("❌ Error: " + (err.message || err));
            } finally {
                document.getElementById("setupProfileBtn").disabled = false;
                document.getElementById("setupProfileBtn").textContent = "🚀 Setup Profile";
            }
        }
        async function submitLink() {
            if (!isConnected) {
                const connected = await showConnectModalAndWait();
                if (!connected) return;
            }
            if (!hasSupported) {
                alert("❌ Please support at least one community member first!");
                return;
            }
            const userLinkVal = document.getElementById('userLinkInput').value.trim();
            if (!userLinkVal) {
                alert("❌ Please enter a link to submit.");
                return;
            }
            if (!userLinkVal.startsWith('http://') && !userLinkVal.startsWith('https://')) {
                alert("❌ Please enter a valid URL (http:// or https://)");
                return;
            }
            try {
                document.getElementById("submitLinkBtn").disabled = true;
                document.getElementById("submitLinkBtn").textContent = "⏳ Processing...";
                const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);
                const existing = await contract.getUserProfile(userAddress);
                let tx;
                if (existing.isActive) {
                    tx = await contract.connect(signer).updateProfile(existing.username || "User", userLinkVal, { gasLimit: 300000 });
                } else {
                    tx = await contract.connect(signer).registerUser(existing.username || "User", userLinkVal, { gasLimit: 500000 });
                }
                alert(`⏳ TX submitted: ${tx.hash}`);
                await tx.wait();
                alert("✅ Submitted successfully");
                const newLinkData = { link: userLinkVal, clickCount: 0, timestamp: Date.now(), submitter: userAddress };
                allCommunityLinks.unshift(newLinkData);
                saveLinksToStorage(allCommunityLinks);
                displaySupportLinks();
                document.getElementById('userLinkInput').value = '';
                hasSupported = false;
                document.getElementById('step2').classList.add('hidden');
                document.getElementById('step1').classList.remove('hidden');
            } catch (err) {
                if (err.code === 4001) alert("❌ Transaction rejected");
                else if (err.code === 'INSUFFICIENT_FUNDS') alert("❌ Insufficient funds for gas.");
                else alert("❌ Submission failed: " + (err.message || err));
            } finally {
                document.getElementById("submitLinkBtn").disabled = false;
                document.getElementById("submitLinkBtn").textContent = "✍️ Submit Link";
            }
        }
        window.addEventListener('load', () => { displaySupportLinks(); });
        window.handleLinkClick = handleLinkClick;
        window.connectWithWallet = connectWithWallet;
        window.connectWallet = () => openWalletModal();
        window.submitLink = submitLink;
        window.setupUserProfile = setupUserProfile;
        document.getElementById('submitLinkBtn').addEventListener('click', submitLink);
        document.getElementById('setupProfileBtn').addEventListener('click', setupUserProfile);
    </script>
</body>
</html>
