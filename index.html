<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Celo Engage Hub</title>
    <style>
        /* ... (T√ºm CSS kodun, √∂ncekiyle neredeyse aynƒ±, sadele≈ütirilmi≈ü ve modal g√ºncellenmi≈ü) ... */
        * { box-sizing: border-box; }
        body { background-color: #ffffff; font-family: Arial, sans-serif; color: #000000; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { display: flex; max-width: 1400px; width: 100%; gap: 30px; align-items: flex-start; }
        .sidebar { width: 300px; flex-shrink: 0; }
        .main-content { flex: 1; display: flex; flex-direction: column; align-items: center; }
        header { background: linear-gradient(135deg, #FBCC5C 0%, #000000 100%); color: white; padding: 25px; font-size: 28px; font-weight: bold; border-radius: 10px; margin-bottom: 10px; text-align: center; width: 100%; max-width: 1400px; }
        .slogan { margin: 5px 0 15px 0; font-size: 22px; color: #000000; font-weight: bold; text-align: center; width: 100%; font-style: italic; }
        .subheader { margin: 0 0 30px 0; font-size: 18px; color: #000000; font-weight: bold; text-align: center; width: 100%; }
        .link-card { border: 2px solid #FBCC5C; padding: 20px; border-radius: 12px; background-color: #FFFDF6; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.3s ease; height: 100%; display: flex; flex-direction: column; justify-content: space-between; }
        .links-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 20px auto; width: 100%; }
        button { background: #FBCC5C; color: black; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; margin: 8px; font-size: 16px; font-weight: bold; transition: all 0.3s ease; }
        button:hover { background: #000000; color: #FBCC5C; transform: translateY(-2px); }
        button:disabled { background: #9ca3af; cursor: not-allowed; transform: none; }
        input, textarea { padding: 12px; border-radius: 8px; border: 2px solid #FBCC5C; width: 90%; max-width: 500px; margin: 15px 0; font-size: 16px; }
        .wallet-info { margin: 0 0 20px 0; padding: 15px; background-color: #FFF9E6; border-radius: 10px; font-weight: bold; border: 2px solid #FBCC5C; text-align: center; width: 100%; }
        .connect-btn { background: #35D07F; color: black; margin: 15px 0; padding: 15px 25px; font-size: 18px; }
        .hidden { display: none !important; }
        .wallet-address { background: #FFF9E6; padding: 12px; border-radius: 8px; margin-bottom: 20px; font-weight: bold; border: 2px solid #FBCC5C; text-align: center; width: 100%; }
        /* Modal styles for Connect Wallet */
        .wallet-modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 9999; }
        .wallet-modal { background: #fff; width: 420px; max-width: calc(100% - 40px); border-radius: 28px; padding: 18px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); border: 1px solid rgba(0,0,0,0.08); }
        .wallet-modal h3 { text-align: center; margin: 6px 0 12px 0; }
        .wallet-option { display:flex; align-items:center; justify-content:space-between; gap:12px; padding:10px; border-radius:12px; cursor:pointer; transition:all .18s ease; }
        .wallet-option:hover { transform: translateX(4px); background: #f7f7f8; }
        .wallet-left { display:flex; align-items:center; gap:12px; }
        .wallet-icon { width:44px; height:44px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:20px; background: #f2f2f2; }
        .wallet-meta { display:flex; flex-direction:column; }
        .wallet-name { font-weight:700; }
        .wallet-status { color: #16a34a; font-weight:700; font-size:13px; }
        .modal-close { position:absolute; right:30px; top:22px; cursor:pointer; font-weight:bold; color:#999; }
        .wallet-list { display:flex; flex-direction:column; gap:8px; margin-top:6px; }
        @media (max-width: 720px) {
            .container { flex-direction: column; padding-bottom: 60px; }
            .sidebar { width: 100%; }
            .wallet-modal { width: 92%; }
        }
    </style>
</head>
<body>
    <div class="centered-content">
        <header>
            <div>üåê Celo Engage Hub</div>
        </header>
        <div class="slogan"> Social TX - Where Every Interaction Builds Real Value </div>
        <div class="subheader">If you want support, support first</div>
        <button id="connectWalletBtn" class="connect-btn">üîó Connect Wallet</button>
    </div>

    <!-- Connect wallet modal -->
    <div id="walletModalBackdrop" class="wallet-modal-backdrop" aria-hidden="true">
        <div class="wallet-modal" role="dialog" aria-modal="true" aria-labelledby="connectWalletTitle">
            <div style="position:relative;">
                <div id="modalClose" class="modal-close">‚úñ</div>
                <h3 id="connectWalletTitle">Connect Wallet</h3>
            </div>
            <div class="wallet-list">
                <div class="wallet-option" onclick="connectWithWallet('metamask')">
                    <div class="wallet-left">
                        <div class="wallet-icon">ü¶ä</div>
                        <div class="wallet-meta">
                            <div class="wallet-name">MetaMask</div>
                        </div>
                    </div>
                    <div style="font-size:13px; color:#666;">Browser extension</div>
                </div>
                <div class="wallet-option" onclick="connectWithWallet('walletconnect')">
                    <div class="wallet-left">
                        <div class="wallet-icon">üîó</div>
                        <div class="wallet-meta">
                            <div class="wallet-name">WalletConnect</div>
                        </div>
                    </div>
                    <div style="font-size:13px; color:#666;">TrustWallet, Rainbow, Coinbase Mobile, Rabby...</div>
                </div>
            </div>
        </div>
    </div>

    <div class="container" style="margin-top:20px;">
        <div class="sidebar">
            <div id="walletInfo" class="wallet-address hidden">
                ‚úÖ Connected: <span id="walletAddress"></span>
                <div id="networkInfo" style="font-size: 12px; margin-top: 5px;"></div>
                <div style="margin-top:10px;">
                    <button id="disconnectBtn" style="background:#ef4444;color:white;padding:10px 12px;border-radius:8px;">Disconnect Wallet</button>
                </div>
            </div>
            <!-- Celo ecosystem links -->
            <div class="celo-ecosystem">
                <h3>üü° Celo Ecosystem</h3>
                <a href="https://celo.org" target="_blank" class="celo-link"> <span class="celo-link-icon">üåê</span>Celo Official </a>
                <a href="https://docs.celo.org" target="_blank" class="celo-link"> <span class="celo-link-icon">üìö</span>Celo Documentation </a>
                <a href="https://developers.celo.org" target="_blank" class="celo-link"> <span class="celo-link-icon">üíº</span>Developer Portal </a>
                <a href="https://celoscan.io" target="_blank" class="celo-link"> <span class="celo-link-icon">üîç</span>Celo Explorer </a>
                <a href="https://forum.celo.org" target="_blank" class="celo-link"> <span class="celo-link-icon">üí¨</span>Celo Forum </a>
                <a href="https://x.com/Celo" target="_blank" class="celo-link"> <span class="celo-link-icon">üê¶</span>Celo Twitter </a>
                <a href="https://chat.celo.org" target="_blank" class="celo-link"> <span class="celo-link-icon">üí¨</span>Celo Discord </a>
                <a href="https://blog.celo.org" target="_blank" class="celo-link"> <span class="celo-link-icon">üì∞</span>Celo Blog </a>
                <a href="https://github.com/celo-org" target="_blank" class="celo-link"> <span class="celo-link-icon">üíª</span>Celo GitHub </a>
            </div>
        </div>
        <div class="main-content">
            <div class="content-layout">
                <!-- USER PROFILE SECTION -->
                <div id="userProfileSection" class="hidden">
                    <div class="step-indicator">
                        <span class="step-number">üë§</span> Your Profile
                    </div>
                    <div class="submit-form">
                        <h3>üÜî Setup Your Profile</h3>
                        <input type="text" placeholder="Enter your username..." id="userUsername" />
                        <input type="text" placeholder="(Optional) Paste your X, Farcaster, GitHub link..." id="userLink" />
                        <div class="gas-info"> ‚õΩ Setup your profile to unlock all features ‚Äî link is optional</div>
                        <button id="setupProfileBtn">üöÄ Setup Profile</button>
                    </div>
                </div>
                <!-- SUBMIT YOUR LINK SECTION -->
                <div id="step2" class="submit-section hidden">
                    <div class="step-indicator">
                        <span class="step-number">2</span> Submit Your Link
                    </div>
                    <div class="success-message"> ‚úÖ Thank you for supporting! Now you can submit your own link </div>
                    <div id="networkWarning" class="network-warning hidden"> ‚ö†Ô∏è Please switch to Celo Mainnet to submit your link </div>
                    <div class="submit-form">
                        <h3>üéâ Add Your Content</h3>
                        <input type="text" placeholder="Paste your X, Farcaster, GitHub, or any other link here..." id="userLinkInput" />
                        <br>
                        <div class="gas-info"> ‚õΩ You'll only pay the normal network gas fee (no extra cost) </div>
                        <button id="submitLinkBtn">‚úçÔ∏è Submit Link</button>
                        <p><small>üîí Secure transaction on Celo network</small></p>
                    </div>
                </div>
                <!-- SUPPORT COMMUNITY SECTION -->
                <div id="step1" class="support-section">
                    <div class="step-indicator">
                        <span class="step-number">1</span> Support Community Members
                    </div>
                    <div class="step-container">
                        <h3>üìã Support Others First</h3>
                        <p>To submit your link, you must first support at least one community member</p>
                        <div class="links-grid" id="linksContainer"> </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- external libraries -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.7.8/dist/umd/index.min.js"></script>
    <script>
        // State
        let provider = null;
        let rawProvider = null;
        let signer = null;
        let isConnected = false;
        let userAddress = '';
        let hasSupported = false;
        let userProfile = null;
        let currentChainId = null;

        // Contract config
        const CONTRACT_ADDRESS = "0x22eA49c074098931a478F381f971C77486d185b2";
        const CONTRACT_ABI = [
            "function registerUser(string memory _username, string memory _link) public",
            "function updateProfile(string memory _username, string memory _link) public",
            "function getUserProfile(address _user) public view returns (string memory link, string memory username, uint256 supportCount, uint256 reputation, uint256 badgeCount, bool isActive, uint256 timestamp)",
            "function totalUsers() public view returns (uint256)",
            "event UserRegistered(address indexed user, string username)"
        ];

        // Network params
        const CELO_MAINNET_PARAMS = {
            chainId: "0xA4EC", // 42220
            chainName: "Celo Mainnet",
            nativeCurrency: { name: "CELO", symbol: "CELO", decimals: 18 },
            rpcUrls: ["https://forno.celo.org"],
            blockExplorerUrls: ["https://celoscan.io/"]
        };
        const CELO_ALFAJORES_PARAMS = {
            chainId: "0xAEF3", // 44787
            chainName: "Celo Alfajores Testnet",
            nativeCurrency: { name: "CELO", symbol: "CELO", decimals: 18 },
            rpcUrls: ["https://alfajores-forno.celo-testnet.org"],
            blockExplorerUrls: ["https://alfajores.celoscan.io/"]
        };

        // initial community links
        const initialSupportLinks = [
            "https://farcaster.xyz/teberen/0x391c5713",
            "https://farcaster.xyz/ertu",
            "https://farcaster.xyz/ratmubaba",
            "https://x.com/erturulsezar13?s=21&t=l2lmnRZcmeoUCu9IdzeRpA",
            "https://x.com/egldmvx?s=21&t=l2lmnRZcmeoUCu9IdzeRpA",
            "https://tebberen.github.io/celo-engage-hub/",
            "https://x.com/meelioodas?s=21&t=l2lmnRZcmeoUCu9IdzeRpA",
            "https://x.com/luckyfromnecef/status/1972371920290259437?s=46&t=l2lmnRZcmeoUCu9IdzeRpA",
            "https://github.com/tebberen"
        ];
        function loadLinksFromStorage() {
            const stored = localStorage.getItem('celoEngageHubLinks');
            if (stored) return JSON.parse(stored);
            return initialSupportLinks.map(link => ({ link, clickCount: 0, timestamp: Date.now(), submitter: "community" }));
        }
        function saveLinksToStorage(links) {
            localStorage.setItem('celoEngageHubLinks', JSON.stringify(links));
        }
        let allCommunityLinks = loadLinksFromStorage();
        function getPlatformName(url) {
            if (url.includes('x.com') || url.includes('twitter.com')) return 'üê¶ X';
            if (url.includes('farcaster.xyz') || url.includes('warpcast.com')) return 'üîÆ Farcaster';
            if (url.includes('github.com')) return 'üíª GitHub';
            if (url.includes('youtube.com')) return 'üì∫ YouTube';
            if (url.includes('discord.com')) return 'üí¨ Discord';
            return 'üåê Website';
        }
        // Support links: no support button, just links
        function displaySupportLinks() {
            const container = document.getElementById('linksContainer');
            container.innerHTML = '';
            const activeLinks = allCommunityLinks.filter(l => l.clickCount < 9999);
            if (activeLinks.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1 / -1;">
                        <div class="link-card">
                            <p>üåü No links yet. Submit new links to continue.</p>
                        </div>
                    </div>`;
                return;
            }
            activeLinks.forEach(linkData => {
                const platform = getPlatformName(linkData.link);
                const div = document.createElement('div');
                div.className = 'link-card';
                div.innerHTML = `
                    <div>
                        <div class="link-platform">${platform}</div>
                        <a href="${linkData.link}" target="_blank" class="support-link" onclick="handleLinkClick(event, '${linkData.link}')">
                            ${linkData.link}
                        </a>
                    </div>
                    <div class="link-stats">
                        <div class="stat-item">
                            <div>Supports</div>
                            <div class="stat-value">${linkData.clickCount}</div>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }
        // User profile loader
        async function loadUserProfile() {
            if (!provider || !isConnected) return;
            try {
                const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);
                const profile = await contract.getUserProfile(userAddress);
                userProfile = {
                    link: profile[0],
                    username: profile[1],
                    supportCount: profile[2],
                    reputation: profile[3],
                    badgeCount: profile[4],
                    isActive: profile[5],
                    timestamp: profile[6]
                };
                if (userProfile.isActive) {
                    document.getElementById('userProfileSection').classList.add('hidden');
                } else {
                    document.getElementById('userProfileSection').classList.remove('hidden');
                }
            } catch (err) {
                console.error("Error loading profile:", err);
                document.getElementById('userProfileSection').classList.remove('hidden');
            }
        }
        // Setup profile: link optional
        async function setupUserProfile() {
            if (!isConnected) {
                const ok = await showConnectModalAndWait();
                if (!ok) return;
            }
            const username = document.getElementById('userUsername').value.trim();
            const link = document.getElementById('userLink').value.trim() || "";
            if (!username) {
                alert("‚ùå Please enter a username");
                return;
            }
            try {
                document.getElementById("setupProfileBtn").disabled = true;
                document.getElementById("setupProfileBtn").textContent = "‚è≥ Processing...";
                const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);
                // check current on-chain profile
                const existing = await contract.getUserProfile(userAddress);
                let tx;
                if (existing.isActive) {
                    tx = await contract.connect(signer).updateProfile(username, link, { gasLimit: 300000 });
                } else {
                    tx = await contract.connect(signer).registerUser(username, link, { gasLimit: 500000 });
                }
                alert(`‚è≥ Transaction submitted\nTX: ${tx.hash}`);
                await tx.wait();
                alert("‚úÖ Profile setup success!");
                loadUserProfile();
            } catch (err) {
                console.error("Profile setup error:", err);
                if (err.code === 4001) {
                    alert("‚ùå Transaction rejected by user");
                } else {
                    alert("‚ùå Error: " + (err.message || err));
                }
            } finally {
                document.getElementById("setupProfileBtn").disabled = false;
                document.getElementById("setupProfileBtn").textContent = "üöÄ Setup Profile";
            }
        }
        // Network helpers
        async function switchToCeloNetwork() {
            if (!rawProvider || !rawProvider.request) return false;
            try {
                try {
                    await rawProvider.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: CELO_MAINNET_PARAMS.chainId }] });
                    return true;
                } catch (switchError) {
                    if (switchError.code === 4902) {
                        await rawProvider.request({ method: 'wallet_addEthereumChain', params: [CELO_MAINNET_PARAMS] });
                        return true;
                    }
                    throw switchError;
                }
            } catch (err) {
                console.warn("Switch to mainnet failed, trying Alfajores", err);
                try {
                    await rawProvider.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: CELO_ALFAJORES_PARAMS.chainId }] });
                    return true;
                } catch (err2) {
                    if (err2.code === 4902) {
                        await rawProvider.request({ method: 'wallet_addEthereumChain', params: [CELO_ALFAJORES_PARAMS] });
                        return true;
                    }
                    console.error("Network switch failed:", err2);
                    return false;
                }
            }
        }
        async function checkCurrentNetwork() {
            if (!provider) return false;
            try {
                const network = await provider.getNetwork();
                currentChainId = network.chainId.toString();
                const ni = document.getElementById('networkInfo');
                const nw = document.getElementById('networkWarning');
                if (currentChainId === "42220" || currentChainId === "44787") {
                    ni.innerHTML = `üåê Celo ${currentChainId === "42220" ? "Mainnet" : "Alfajores"}`;
                    ni.style.color = "#35D07F";
                    nw.classList.add('hidden');
                    return true;
                } else {
                    ni.innerHTML = `‚ö†Ô∏è Wrong Network - Please switch to Celo`;
                    ni.style.color = "#EF4444";
                    nw.classList.remove('hidden');
                    return false;
                }
            } catch (err) {
                console.error("check network error:", err);
                return false;
            }
        }
        // Link click handling
        function handleLinkClick(event, linkUrl) {
            try {
                // increment support count
                const linkData = allCommunityLinks.find(l => l.link === linkUrl);
                if (linkData) {
                    linkData.clickCount = (linkData.clickCount || 0) + 1;
                    saveLinksToStorage(allCommunityLinks);
                    displaySupportLinks();
                    hasSupported = true;
                }
                // special behavior for teberen page
                if (linkUrl.includes('tebberen.github.io/celo-engage-hub')) {
                    window.open(linkUrl, '_blank');
                    document.getElementById('userLinkInput').value = linkUrl;
                    document.getElementById('step1').classList.add('hidden');
                    document.getElementById('step2').classList.remove('hidden');
                    event.preventDefault();
                    return;
                }
                // default anchor opens new tab.
            } catch (err) {
                console.error("handleLinkClick error:", err);
            }
        }
        // Disconnect
        async function disconnectWallet() {
            try {
                if (rawProvider && rawProvider.disconnect && typeof rawProvider.disconnect === 'function') {
                    try { await rawProvider.disconnect(); } catch (e) { console.warn("Provider disconnect error:", e); }
                }
            } catch (err) {
                console.error("Error during disconnect:", err);
            } finally {
                provider = null;
                rawProvider = null;
                signer = null;
                isConnected = false;
                userAddress = '';
                document.getElementById('walletInfo').classList.add('hidden');
                document.getElementById('connectWalletBtn').style.display = 'inline-block';
                document.getElementById('userProfileSection').classList.add('hidden');
                document.getElementById('step1').classList.remove('hidden');
                document.getElementById('step2').classList.add('hidden');
            }
        }
        // Connect modal & logic
        const walletModalBackdrop = document.getElementById('walletModalBackdrop');
        const connectBtn = document.getElementById('connectWalletBtn');
        const modalClose = document.getElementById('modalClose');
        const disconnectBtn = document.getElementById('disconnectBtn');
        connectBtn.addEventListener('click', () => { openWalletModal(); });
        modalClose.addEventListener('click', closeWalletModal);
        walletModalBackdrop.addEventListener('click', (e) => { if (e.target === walletModalBackdrop) closeWalletModal(); });
        disconnectBtn.addEventListener('click', () => { disconnectWallet(); });
        function openWalletModal() { walletModalBackdrop.style.display = 'flex'; walletModalBackdrop.setAttribute('aria-hidden', 'false'); }
        function closeWalletModal() { walletModalBackdrop.style.display = 'none'; walletModalBackdrop.setAttribute('aria-hidden', 'true'); }
        function showConnectModalAndWait() {
            return new Promise((resolve) => {
                openWalletModal();
                const cleanup = () => { document.removeEventListener('walletConnectedTemp', onConnected); };
                function onConnected() { cleanup(); resolve(true); }
                document.addEventListener('walletConnectedTemp', onConnected);
                const observer = new MutationObserver(() => {
                    if (walletModalBackdrop.style.display === 'none') {
                        setTimeout(() => { if (!isConnected) { cleanup(); resolve(false); } }, 200);
                        observer.disconnect();
                    }
                });
                observer.observe(walletModalBackdrop, { attributes: true, attributeFilter: ['style'] });
            });
        }
        async function connectWithWallet(method) {
            closeWalletModal();
            try {
                if (method === 'metamask') {
                    if (!window.ethereum) {
                        const url = 'https://metamask.io/download/';
                        if (confirm("MetaMask not detected. Open MetaMask download page?")) window.open(url, '_blank');
                        return;
                    }
                    rawProvider = window.ethereum;
                    provider = new ethers.providers.Web3Provider(rawProvider);
                    await rawProvider.request({ method: 'eth_requestAccounts' });
                    signer = provider.getSigner();
                } else if (method === 'walletconnect') {
                    const WalletConnectProvider = window.WalletConnectProvider.default || window.WalletConnectProvider;
                    const wcProvider = new WalletConnectProvider({
                        rpc: {
                            42220: 'https://forno.celo.org',
                            44787: 'https://alfajores-forno.celo-testnet.org'
                        },
                        chainId: 42220
                    });
                    await wcProvider.enable();
                    rawProvider = wcProvider;
                    provider = new ethers.providers.Web3Provider(wcProvider);
                    signer = provider.getSigner();
                    wcProvider.on("disconnect", (code, reason) => { disconnectWallet(); });
                } else {
                    await connectWithWallet('walletconnect');
                    return;
                }
                userAddress = await signer.getAddress();
                isConnected = true;
                document.getElementById('walletAddress').textContent = `${userAddress.substring(0,6)}...${userAddress.substring(userAddress.length - 4)}`;
                document.getElementById('walletInfo').classList.remove('hidden');
                document.getElementById('connectWalletBtn').style.display = 'none';
                await checkCurrentNetwork();
                loadUserProfile();
                document.dispatchEvent(new Event('walletConnectedTemp'));
            } catch (err) {
                console.error("connectWithWallet error:", err);
                if (err && err.code === 4001) alert("‚ùå Connection request rejected");
                else alert("‚ùå Connection failed: " + (err.message || err));
            }
        }
        async function submitLink() {
            if (!isConnected) {
                const connected = await showConnectModalAndWait();
                if (!connected) return;
            }
            if (!hasSupported) {
                alert("‚ùå Please support at least one community member first!");
                return;
            }
            const okNetwork = await checkCurrentNetwork();
            if (!okNetwork) {
                alert("‚ùå Please switch your wallet to Celo network first.");
                return;
            }
            const userLinkVal = document.getElementById('userLinkInput').value.trim();
            if (!userLinkVal) {
                alert("‚ùå Please enter a link to submit.");
                return;
            }
            if (!userLinkVal.startsWith('http://') && !userLinkVal.startsWith('https://')) {
                alert("‚ùå Please enter a valid URL (http:// or https://)");
                return;
            }
            try {
                document.getElementById("submitLinkBtn").disabled = true;
                document.getElementById("submitLinkBtn").textContent = "‚è≥ Processing...";
                const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);
                const existing = await contract.getUserProfile(userAddress);
                let tx;
                if (existing.isActive) {
                    tx = await contract.connect(signer).updateProfile("User", userLinkVal, { gasLimit: 300000 });
                } else {
                    tx = await contract.connect(signer).registerUser("User", userLinkVal, { gasLimit: 500000 });
                }
                alert(`‚è≥ TX submitted: ${tx.hash}`);
                await tx.wait();
                alert("‚úÖ Submitted successfully");
                const newLinkData = { link: userLinkVal, clickCount: 0, timestamp: Date.now(), submitter: userAddress };
                allCommunityLinks.unshift(newLinkData);
                saveLinksToStorage(allCommunityLinks);
                displaySupportLinks();
                document.getElementById('userLinkInput').value = '';
                hasSupported = false;
                document.getElementById('step2').classList.add('hidden');
                document.getElementById('step1').classList.remove('hidden');
            } catch (err) {
                console.error("submitLink error:", err);
                if (err.code === 4001) alert("‚ùå Transaction rejected");
                else if (err.code === 'INSUFFICIENT_FUNDS') alert("‚ùå Insufficient funds for gas.");
                else alert("‚ùå Submission failed: " + (err.message || err));
            } finally {
                document.getElementById("submitLinkBtn").disabled = false;
                document.getElementById("submitLinkBtn").textContent = "‚úçÔ∏è Submit Link";
            }
        }
        window.addEventListener('load', () => { displaySupportLinks(); });
        if (window.ethereum) {
            window.ethereum.on('chainChanged', (chainIdHex) => {
                try {
                    currentChainId = parseInt(chainIdHex, 16).toString();
                    checkCurrentNetwork();
                    if (isConnected) loadUserProfile();
                } catch (err) { }
            });
            window.ethereum.on('accountsChanged', (accounts) => {
                if (!accounts || accounts.length === 0) {
                    disconnectWallet();
                } else {
                    userAddress = accounts[0];
                    document.getElementById('walletAddress').textContent = `${userAddress.substring(0,6)}...${userAddress.substring(userAddress.length - 4)}`;
                    loadUserProfile();
                }
            });
        }
        window.handleLinkClick = handleLinkClick;
        window.connectWithWallet = connectWithWallet;
        window.connectWallet = () => openWalletModal();
        window.submitLink = submitLink;
        window.setupUserProfile = setupUserProfile;
        document.getElementById('submitLinkBtn').addEventListener('click', submitLink);
        document.getElementById('setupProfileBtn').addEventListener('click', setupUserProfile);
    </script>
</body>
</html>
