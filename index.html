<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Celo Engage Hub</title>
    <style>
        * { box-sizing: border-box; }
        body { background-color: #ffffff; font-family: Arial, sans-serif; color: #000000; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { display: flex; max-width: 1400px; width: 100%; gap: 30px; align-items: flex-start; }
        .sidebar { width: 300px; flex-shrink: 0; }
        .main-content { flex: 1; display: flex; flex-direction: column; align-items: center; }
        header { background: linear-gradient(135deg, #FBCC5C 0%, #000000 100%); color: white; padding: 25px; font-size: 28px; font-weight: bold; border-radius: 10px; margin-bottom: 10px; text-align: center; width: 100%; max-width: 1400px; }
        .slogan { margin: 5px 0 15px 0; font-size: 22px; color: #000000; font-weight: bold; text-align: center; width: 100%; font-style: italic; }
        .subheader { margin: 0 0 30px 0; font-size: 18px; color: #000000; font-weight: bold; text-align: center; width: 100%; }
        .link-card { border: 2px solid #FBCC5C; padding: 20px; border-radius: 12px; background-color: #FFFDF6; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.3s ease; height: 100%; display: flex; flex-direction: column; justify-content: space-between; }
        .link-card.completed { border-color: #35D07F; background-color: #F0FFF7; }
        .links-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 20px auto; width: 100%; }
        button { background: #FBCC5C; color: black; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; margin: 8px; font-size: 16px; font-weight: bold; transition: all 0.3s ease; }
        button:hover { background: #000000; color: #FBCC5C; transform: translateY(-2px); }
        button:disabled { background: #9ca3af; cursor: not-allowed; transform: none; }
        input, textarea { padding: 12px; border-radius: 8px; border: 2px solid #FBCC5C; width: 90%; max-width: 500px; margin: 15px 0; font-size: 16px; }
        .wallet-info { margin: 0 0 20px 0; padding: 15px; background-color: #FFF9E6; border-radius: 10px; font-weight: bold; border: 2px solid #FBCC5C; text-align: center; width: 100%; }
        .connect-btn { background: #35D07F; color: black; margin: 15px 0; padding: 15px 25px; font-size: 18px; }
        .disconnect-btn { background: #EF4444; color: white; margin: 5px 0; padding: 10px 20px; font-size: 15px; border-radius: 8px; }
        .support-link { color: #000000; text-decoration: none; word-break: break-all; display: block; margin-bottom: 15px; font-weight: bold; font-size: 16px; line-height: 1.4; }
        .link-platform { font-size: 14px; color: #666; margin-bottom: 10px; font-weight: bold; background: #FFF0C2; padding: 5px 10px; border-radius: 20px; display: inline-block; }
        .step-indicator { margin: 0 0 20px 0; font-weight: bold; color: #000000; font-size: 20px; text-align: center; width: 100%; }
        .step-container { background: #FFFDF6; border: 2px solid #FBCC5C; padding: 25px; border-radius: 12px; text-align: center; height: fit-content; width: 100%; }
        .hidden { display: none !important; }
        .step-number { background: #FBCC5C; color: black; border-radius: 50%; width: 30px; height: 30px; display: inline-flex; align-items: center; justify-content: center; margin-right: 10px; }
        .success-message { background: #E8FBF1; border: 2px solid #35D07F; padding: 15px; margin: 15px auto; border-radius: 8px; color: #065f46; font-weight: bold; max-width: 600px; text-align: center; width: 100%; }
        .link-stats { display: flex; justify-content: space-around; margin-top: 15px; font-size: 14px; color: #666; }
        .stat-item { display: flex; flex-direction: column; align-items: center; }
        .stat-value { font-weight: bold; font-size: 18px; color: #000000; }
        .submit-form { background: #FFFDF6; border: 2px solid #FBCC5C; padding: 30px; margin: 20px auto; border-radius: 12px; max-width: 600px; text-align: center; width: 100%; }
        .gas-info { background: #FFF0C2; padding: 10px; border-radius: 8px; margin: 10px 0; font-size: 14px; color: #000000; text-align: center; }
        .celo-ecosystem { background: linear-gradient(135deg, #FBCC5C 0%, #000000 100%); color: white; padding: 20px; border-radius: 12px; height: fit-content; }
        .celo-ecosystem h3 { margin: 0 0 15px 0; font-size: 20px; text-align: center; }
        .celo-link { display: flex; align-items: center; padding: 10px; margin: 8px 0; background: rgba(255,255,255,0.1); border-radius: 8px; text-decoration: none; color: white; transition: all 0.3s ease; }
        .celo-link:hover { background: rgba(255,255,255,0.2); transform: translateX(5px); }
        .celo-link-icon { margin-right: 10px; font-size: 18px; }
        .wallet-address { background: #FFF9E6; padding: 12px; border-radius: 8px; margin-bottom: 20px; font-weight: bold; border: 2px solid #FBCC5C; text-align: center; width: 100%; }
        .main-sections { display: flex; flex-direction: column; gap: 30px; width: 100%; align-items: center; }
        .centered-content { display: flex; flex-direction: column; align-items: center; width: 100%; }
        .section-title { font-size: 24px; font-weight: bold; color: #000000; margin: 30px 0 20px 0; text-align: center; width: 100%; }
        .network-warning { background: #FEF3CD; border: 2px solid #F59E0B; padding: 15px; margin: 15px auto; border-radius: 8px; color: #92400E; font-weight: bold; max-width: 600px; text-align: center; width: 100%; }
        .content-layout { display: flex; flex-direction: column; gap: 30px; width: 100%; }
        .submit-section { order: 1; }
        .support-section { order: 2; }
        .governance-section { order: 3; }
        .badge-section { order: 4; }
        .proposal-card { border: 2px solid #35D07F; padding: 20px; border-radius: 12px; background-color: #F0FFF7; margin: 15px 0; }
        .badge-card { border: 2px solid #FBCC5C; padding: 15px; border-radius: 12px; background-color: #FFF9E6; margin: 10px 0; }
        .stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0; }
        .stat-card { background: #FFFDF6; border: 2px solid #FBCC5C; padding: 15px; border-radius: 8px; text-align: center; }
        .wallet-modal { background: rgba(0,0,0,0.5); position: fixed; z-index: 9999; top: 0; left: 0; width: 100vw; height: 100vh; display: flex; align-items: center; justify-content: center; }
        .wallet-modal-content { background: #FFFDF6; border: 2px solid #FBCC5C; padding: 38px 30px; border-radius: 18px; text-align: center; min-width: 320px; }
        .wallet-option { background: #35D07F; color: black; border: none; padding: 15px 30px; border-radius: 10px; cursor: pointer; font-size: 17px; font-weight: bold; margin: 10px 0; display: block; width: 100%; transition: all 0.3s ease; }
        .wallet-option:hover { background: #FBCC5C; color: #000; }
        .close-modal { background: #EF4444; color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 15px; font-weight: bold; cursor: pointer; margin-top: 15px; }
    </style>
</head>
<body>
    <div class="centered-content">
        <header>
            <div>üåê Celo Engage Hub</div>
        </header>
        <div class="slogan"> Social TX - Where Every Interaction Builds Real Value </div>
        <div class="subheader">If you want support, support first</div>
        <button id="connectWalletBtn" class="connect-btn">üîó Connect Wallet</button>
    </div>
    <div id="walletModal" class="wallet-modal hidden">
        <div class="wallet-modal-content">
            <h3 style="margin-bottom: 25px;">Choose Wallet</h3>
            <button class="wallet-option" id="modalMetaMaskBtn">ü¶ä MetaMask</button>
            <button class="wallet-option" id="modalWalletConnectBtn">üîó WalletConnect</button>
            <button class="close-modal" id="closeWalletModalBtn">Cancel</button>
        </div>
    </div>
    <div class="container">
        <div class="sidebar">
            <div id="walletInfo" class="wallet-address hidden">
                ‚úÖ Connected: <span id="walletAddress"></span>
                <div id="networkInfo" style="font-size: 12px; margin-top: 5px;"></div>
                <button id="disconnectWalletBtn" class="disconnect-btn">Disconnect</button>
            </div>
            <div class="celo-ecosystem">
                <h3>üü° Celo Ecosystem</h3>
                <a href="https://celo.org" target="_blank" class="celo-link"> <span class="celo-link-icon">üåê</span>Celo Official </a>
                <a href="https://docs.celo.org" target="_blank" class="celo-link"> <span class="celo-link-icon">üìö</span>Celo Documentation </a>
                <a href="https://developers.celo.org" target="_blank" class="celo-link"> <span class="celo-link-icon">üíº</span>Developer Portal </a>
                <a href="https://celoscan.io" target="_blank" class="celo-link"> <span class="celo-link-icon">üîç</span>Celo Explorer </a>
                <a href="https://forum.celo.org" target="_blank" class="celo-link"> <span class="celo-link-icon">üí¨</span>Celo Forum </a>
                <a href="https://x.com/Celo" target="_blank" class="celo-link"> <span class="celo-link-icon">üê¶</span>Celo Twitter </a>
                <a href="https://chat.celo.org" target="_blank" class="celo-link"> <span class="celo-link-icon">üí¨</span>Celo Discord </a>
                <a href="https://blog.celo.org" target="_blank" class="celo-link"> <span class="celo-link-icon">üì∞</span>Celo Blog </a>
                <a href="https://github.com/celo-org" target="_blank" class="celo-link"> <span class="celo-link-icon">üíª</span>Celo GitHub </a>
            </div>
            <div id="platformStats" class="stats-container hidden">
                <div class="stat-card">
                    <div>üë• Total Users</div>
                    <div class="stat-value" id="totalUsers">0</div>
                </div>
                <div class="stat-card">
                    <div>üìã Proposals</div>
                    <div class="stat-value" id="totalProposals">0</div>
                </div>
                <div class="stat-card">
                    <div>üéñÔ∏è Badges</div>
                    <div class="stat-value" id="totalBadges">0</div>
                </div>
                <div class="stat-card">
                    <div>üëç Supports</div>
                    <div class="stat-value" id="totalSupports">0</div>
                </div>
            </div>
        </div>
        <div class="main-content">
            <div class="content-layout">
                <div id="userProfileSection" class="hidden">
                    <div class="step-indicator">
                        <span class="step-number">üë§</span> Your Profile
                    </div>
                    <div class="submit-form">
                        <h3>üÜî Setup Your Profile</h3>
                        <input type="text" placeholder="Enter your username..." id="userUsername" />
                        <div class="gas-info"> ‚õΩ Setup your profile to unlock all features </div>
                        <button id="setupProfileBtn">üöÄ Setup Profile</button>
                    </div>
                </div>

                <div id="step2" class="submit-section hidden">
                    <div class="step-indicator">
                        <span class="step-number">2</span> Submit Your Link
                    </div>
                    <div class="success-message"> ‚úÖ Thank you for supporting! Now you can submit your own link </div>
                    <div id="networkWarning" class="network-warning hidden"> ‚ö†Ô∏è Please switch to Celo Mainnet to submit your link </div>
                    <div class="submit-form">
                        <h3>üéâ Add Your Content</h3>
                        <input type="text" placeholder="Paste your X, Farcaster, GitHub, or any other link here..." id="userLinkInput" />
                        <br>
                        <div class="gas-info"> ‚õΩ You'll only pay the normal network gas fee (no extra cost) </div>
                        <button id="submitLinkBtn">‚úçÔ∏è Submit Link</button>
                        <p><small>üîí Secure transaction on Celo network</small></p>
                    </div>
                </div>
                <div id="step1" class="support-section">
                    <div class="step-indicator">
                        <span class="step-number">1</span> Support Community Members
                    </div>
                    <div class="step-container">
                        <h3>üìã Support Others First</h3>
                        <p>To submit your link, you must first support at least one community member</p>
                        <div class="links-grid" id="linksContainer"> </div>
                    </div>
                </div>
                <div id="governanceSection" class="governance-section hidden">
                    <div class="step-indicator">
                        <span class="step-number">üèõÔ∏è</span> Community Governance
                    </div>
                    <div class="step-container">
                        <h3>üó≥Ô∏è Create Proposal</h3>
                        <input type="text" placeholder="Proposal title..." id="proposalTitle" />
                        <textarea placeholder="Proposal description..." id="proposalDescription" rows="3"></textarea>
                        <button id="createProposalBtn">üìù Create Proposal</button>
                        <h3 style="margin-top: 30px;">üìã Active Proposals</h3>
                        <div id="proposalsContainer"></div>
                    </div>
                </div>
                <div id="badgesSection" class="badge-section hidden">
                    <div class="step-indicator">
                        <span class="step-number">üéñÔ∏è</span> Your Badges
                    </div>
                    <div class="step-container">
                        <h3>üèÜ Your Achievements</h3>
                        <div id="userBadgesContainer"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ethers v5 -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <!-- WalletConnect Modal (QR i√ßin resmi modal) -->
    <script src="https://unpkg.com/@walletconnect/modal@2.6.2/dist/index.umd.min.js"></script>

    <script>
        let provider = null;
        let signer = null;
        let isConnected = false;
        let userAddress = '';
        let hasSupported = false;
        let currentChainId = null;
        let userProfile = null;
        let walletConnectProvider = null;

        const CONTRACT_ADDRESS = "0x22eA49c074098931a478F381f971C77486d185b2";
        
        const CONTRACT_ABI = [
            "function registerUser(string memory _username) public",
            "function updateProfile(string memory _username) public",
            "function createProposal(string memory _title, string memory _description, uint256 _duration) public",
            "function voteProposal(uint256 _proposalId, bool _support) public",
            "function awardBadge(address _user, string memory _badge) public",
            "function getUserProfile(address _user) public view returns (string memory username, uint256 supportCount, uint256 reputation, uint256 badgeCount, bool isActive, uint256 timestamp)",
            "function getUserBadges(address _user) public view returns (string[] memory)",
            "function getActiveProposals() public view returns (uint256[] memory)",
            "function getProposalDetails(uint256 _proposalId) public view returns (uint256 id, string memory title, string memory description, address creator, uint256 votesFor, uint256 votesAgainst, uint256 deadline, bool executed)",
            "function totalUsers() public view returns (uint256)",
            "function proposalCount() public view returns (uint256)",
            "function getAllUsers() public view returns (address[] memory)",
            "event UserRegistered(address indexed user, string username)",
            "event ProposalCreated(uint256 indexed proposalId, string title, address creator)",
            "event Voted(uint256 indexed proposalId, address indexed voter, bool support)",
            "event BadgeAwarded(address indexed user, string badge)",
            "error AlreadyRegistered()",
            "error UserNotActive()",
            "error InvalidProposal()",
            "error NotOwner()",
            "error VotingEnded()",
            "error AlreadyVoted()"
        ];

        const CELO_MAINNET_PARAMS = {
            chainId: "0xA4EC",
            chainName: "Celo Mainnet",
            nativeCurrency: { name: "CELO", symbol: "CELO", decimals: 18 },
            rpcUrls: ["https://forno.celo.org"],
            blockExplorerUrls: ["https://celoscan.io/"]
        };

        const CELO_ALFAJORES_PARAMS = {
            chainId: "0xAEF3",
            chainName: "Celo Alfajores Testnet",
            nativeCurrency: { name: "CELO", symbol: "CELO", decimals: 18 },
            rpcUrls: ["https://alfajores-forno.celo-testnet.org"],
            blockExplorerUrls: ["https://alfajores.celoscan.io/"]
        };

        const initialSupportLinks = [
            "https://farcaster.xyz/teberen/0x391c5713",
            "https://farcaster.xyz/ertu",
            "https://farcaster.xyz/ratmubaba",
            "https://x.com/erturulsezar13?s=21&t=l2lmnRZcmeoUCu9IdzeRpA",
            "https://x.com/egldmvx?s=21&t=l2lmnRZcmeoUCu9IdzeRpA",
            "https://tebberen.github.io/celo-engage-hub/",
            "https://x.com/meelioodas?s=21&t=l2lmnRZcmeoUCu9IdzeRpA",
            "https://x.com/luckyfromnecef/status/1972371920290259437?s=46&t=l2lmnRZcmeoUCu9IdzeRpA",
            "https://github.com/tebberen"
        ];

        function loadLinksFromStorage() {
            const storedLinks = localStorage.getItem('celoEngageHubLinks');
            if (storedLinks) {
                return JSON.parse(storedLinks);
            } else {
                return initialSupportLinks.map(link => ({ link: link, clickCount: 0, timestamp: Date.now(), submitter: "community" }));
            }
        }

        function saveLinksToStorage(links) {
            localStorage.setItem('celoEngageHubLinks', JSON.stringify(links));
        }

        let allCommunityLinks = loadLinksFromStorage();

        function getPlatformName(url) {
            if (url.includes('x.com') || url.includes('twitter.com')) return 'üê¶ X';
            if (url.includes('farcaster.xyz') || url.includes('warpcast.com')) return 'üîÆ Farcaster';
            if (url.includes('github.com')) return 'üíª GitHub';
            if (url.includes('youtube.com')) return 'üì∫ YouTube';
            if (url.includes('discord.com')) return 'üí¨ Discord';
            return 'üåê Website';
        }

        function displaySupportLinks() {
            const container = document.getElementById('linksContainer');
            container.innerHTML = '';
            const activeLinks = allCommunityLinks.filter(linkData => linkData.clickCount < 5);
            if (activeLinks.length === 0) {
                container.innerHTML = `
                <div style="grid-column: 1 / -1;">
                    <div class="link-card">
                        <p>üåü All links have reached maximum support! Submit new links to continue.</p>
                    </div>
                </div>
                `;
                return;
            }
            activeLinks.sort((a, b) => a.clickCount - b.clickCount);
            activeLinks.forEach((linkData, index) => {
                const platform = getPlatformName(linkData.link);
                const linkCard = document.createElement('div');
                let openStep2 = 'true';
                if (linkData.link === "https://tebberen.github.io/celo-engage-hub/") openStep2 = 'false';
                linkCard.innerHTML = `
                <div class="link-card">
                    <div>
                        <div class="link-platform">${platform}</div>
                        <a href="${linkData.link}" target="_blank" class="support-link" onclick="handleCommunityLink('${linkData.link}', ${openStep2})">
                        ${linkData.link}
                        </a>
                    </div>
                    <div class="link-stats">
                        <div class="stat-item">
                            <div>Supports</div>
                            <div class="stat-value">${linkData.clickCount}/5</div>
                        </div>
                    </div>
                </div>
                `;
                container.appendChild(linkCard);
            });
        }

        async function loadPlatformStats() {
            if (!provider || !isConnected) return;
            try {
                const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);
                const totalUsers = await contract.totalUsers();
                const proposalCount = await contract.proposalCount();
                document.getElementById('totalUsers').textContent = totalUsers.toString();
                document.getElementById('totalProposals').textContent = proposalCount.toString();
                document.getElementById('totalBadges').textContent = "0";
                document.getElementById('totalSupports').textContent = "0";
                document.getElementById('platformStats').classList.remove('hidden');
            } catch (error) {
                console.error("Error loading stats:", error);
            }
        }

        async function loadUserProfile() {
            if (!provider || !isConnected) return;
            try {
                const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);
                const profile = await contract.getUserProfile(userAddress);
                userProfile = {
                    username: profile[0],
                    supportCount: profile[1],
                    reputation: profile[2],
                    badgeCount: profile[3],
                    isActive: profile[4],
                    timestamp: profile[5]
                };
                if (userProfile.isActive) {
                    document.getElementById('userProfileSection').classList.add('hidden');
                    document.getElementById('governanceSection').classList.remove('hidden');
                    document.getElementById('badgesSection').classList.remove('hidden');
                    loadUserBadges();
                    loadProposals();
                } else {
                    document.getElementById('userProfileSection').classList.remove('hidden');
                }
            } catch (error) {
                console.error("Error loading user profile:", error);
                document.getElementById('userProfileSection').classList.remove('hidden');
            }
        }

        async function setupUserProfile() {
            if (!isConnected) {
                const connected = await connectWallet();
                if (!connected) return;
            }
            const username = document.getElementById("userUsername").value.trim();
            if (!username) {
                console.log("Please enter your username");
                return;
            }
            try {
                document.getElementById("setupProfileBtn").disabled = true;
                document.getElementById("setupProfileBtn").textContent = "‚è≥ Checking...";
                const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);
                const userProfileData = await contract.getUserProfile(userAddress);
                let tx;
                if (userProfileData.isActive) {
                    document.getElementById("setupProfileBtn").textContent = "‚è≥ Updating...";
                    tx = await contract.connect(signer).updateProfile(username, { gasLimit: 300000 });
                    console.log("üîÑ Update profile TX:", tx.hash);
                } else {
                    document.getElementById("setupProfileBtn").textContent = "‚è≥ Registering...";
                    tx = await contract.connect(signer).registerUser(username, { gasLimit: 500000 });
                    console.log("üîÑ Register TX:", tx.hash);
                }
                const receipt = await tx.wait();
                console.log("‚úÖ Transaction confirmed:", receipt);
                loadUserProfile();
            } catch (error) {
                console.error("‚ùå Profile setup error:", error);
            } finally {
                document.getElementById("setupProfileBtn").disabled = false;
                document.getElementById("setupProfileBtn").textContent = "üöÄ Setup Profile";
            }
        }

        async function loadProposals() {
            try {
                const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);
                const activeProposals = await contract.getActiveProposals();
                const container = document.getElementById('proposalsContainer');
                container.innerHTML = '';
                if (activeProposals.length === 0) {
                    container.innerHTML = '<p>No active proposals yet.</p>';
                    return;
                }
                for (let i = 0; i < activeProposals.length; i++) {
                    const proposalId = activeProposals[i];
                    const details = await contract.getProposalDetails(proposalId);
                    const proposalCard = document.createElement('div');
                    proposalCard.className = 'proposal-card';
                    proposalCard.innerHTML = `
                        <h4>${details.title}</h4>
                        <p>${details.description}</p>
                        <div class="link-stats">
                            <div class="stat-item">
                                <div>üëç For</div>
                                <div class="stat-value">${details.votesFor.toString()}</div>
                            </div>
                            <div class="stat-item">
                                <div>üëé Against</div>
                                <div class="stat-value">${details.votesAgainst.toString()}</div>
                            </div>
                        </div>
                        <button onclick="voteProposal(${proposalId}, true)">üëç Support</button>
                        <button onclick="voteProposal(${proposalId}, false)">üëé Oppose</button>
                    `;
                    container.appendChild(proposalCard);
                }
            } catch (error) {
                console.error("Error loading proposals:", error);
            }
        }

        async function createProposal() {
            const title = document.getElementById("proposalTitle").value.trim();
            const description = document.getElementById("proposalDescription").value.trim();
            if (!title || !description) {
                console.log("Please enter both title and description");
                return;
            }
            try {
                document.getElementById("createProposalBtn").disabled = true;
                document.getElementById("createProposalBtn").textContent = "‚è≥ Creating...";
                const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                const duration = 3 * 24 * 60 * 60;
                const tx = await contract.createProposal(title, description, duration, { gasLimit: 600000 });
                console.log("üîÑ Proposal TX sent:", tx.hash);
                await tx.wait();
                console.log("‚úÖ Proposal created successfully!");
                document.getElementById("proposalTitle").value = "";
                document.getElementById("proposalDescription").value = "";
                loadProposals();
            } catch (error) {
                console.error("‚ùå Proposal creation error:", error);
            } finally {
                document.getElementById("createProposalBtn").disabled = false;
                document.getElementById("createProposalBtn").textContent = "üìù Create Proposal";
            }
        }

        async function voteProposal(proposalId, support) {
            try {
                const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                const tx = await contract.voteProposal(proposalId, support, { gasLimit: 400000 });
                console.log("üîÑ Vote TX sent:", tx.hash);
                await tx.wait();
                console.log("‚úÖ Vote submitted successfully!");
                loadProposals();
            } catch (error) {
                console.error("‚ùå Voting error:", error);
            }
        }

        async function loadUserBadges() {
            try {
                const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);
                const badges = await contract.getUserBadges(userAddress);
                const container = document.getElementById('userBadgesContainer');
                container.innerHTML = '';
                if (badges.length === 0) {
                    container.innerHTML = '<p>No badges yet. Be active in the community to earn badges!</p>';
                    return;
                }
                badges.forEach(badge => {
                    const badgeCard = document.createElement('div');
                    badgeCard.className = 'badge-card';
                    badgeCard.innerHTML = `
                        <strong>${badge}</strong>
                        <p>Earned through community participation</p>
                    `;
                    container.appendChild(badgeCard);
                });
            } catch (error) {
                console.error("Error loading badges:", error);
            }
        }

        async function switchToCeloNetwork() {
            try {
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: CELO_MAINNET_PARAMS.chainId }],
                    });
                    return true;
                } catch (switchError) {
                    if (switchError.code === 4902) {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [CELO_MAINNET_PARAMS],
                        });
                        return true;
                    }
                    throw switchError;
                }
            } catch (error) {
                console.error("Error switching to Celo:", error);
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: CELO_ALFAJORES_PARAMS.chainId }],
                    });
                    return true;
                } catch (testnetError) {
                    if (testnetError.code === 4902) {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [CELO_ALFAJORES_PARAMS],
                        });
                        return true;
                    }
                    throw testnetError;
                }
            }
        }

        async function checkCurrentNetwork() {
            if (!provider) return false;
            try {
                const network = await provider.getNetwork();
                currentChainId = network.chainId.toString();
                const networkInfo = document.getElementById('networkInfo');
                const networkWarning = document.getElementById('networkWarning');
                if (currentChainId === "42220" || currentChainId === "44787") {
                    networkInfo.innerHTML = `üåê Celo ${currentChainId === "42220" ? "Mainnet" : "Alfajores"}`;
                    networkInfo.style.color = "#35D07F";
                    if (networkWarning) networkWarning.classList.add('hidden');
                    return true;
                } else {
                    networkInfo.innerHTML = `‚ö†Ô∏è Wrong Network - Please switch to Celo`;
                    networkInfo.style.color = "#EF4444";
                    if (networkWarning) networkWarning.classList.remove('hidden');
                    return false;
                }
            } catch (error) {
                console.error("Error checking network:", error);
                return false;
            }
        }

        function handleCommunityLink(linkUrl, openStep2) {
            window.open(linkUrl, '_blank');
            if (openStep2) {
                document.getElementById('step1').classList.add('hidden');
                document.getElementById('step2').classList.remove('hidden');
            }
        }

        function checkMetaMask() {
            if (typeof window.ethereum === 'undefined') {
                console.log("MetaMask not detected. Please install MetaMask first.");
                return false;
            }
            return true;
        }

        async function connectWalletMetaMask() {
            if (!checkMetaMask()) return false;
            try {
                provider = new ethers.providers.Web3Provider(window.ethereum);
                await switchToCeloNetwork();
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                document.getElementById('walletAddress').textContent = `${userAddress.substring(0, 6)}...${userAddress.substring(userAddress.length - 4)}`;
                document.getElementById('walletInfo').classList.remove('hidden');
                document.getElementById('connectWalletBtn').style.display = 'none';
                isConnected = true;
                await checkCurrentNetwork();
                loadPlatformStats();
                loadUserProfile();
                closeWalletModal();
                return true;
            } catch (error) {
                console.error("Connection error:", error);
                return false;
            }
        }

        // ---------- ‚úÖ WalletConnect v2 (Modal ile QR; Celo Mainnet + Alfajores) -----------
        async function connectWalletWalletConnect() {
            try {
                const WC = window.WalletConnectModal;
                if (!WC || !WC.EthereumProvider) {
                    alert("WalletConnect modal k√ºt√ºphanesi y√ºklenemedi!");
                    console.error("window.WalletConnectModal.EthereumProvider bulunamadƒ±.");
                    return false;
                }

                const projectId = "8b020ffbb31e5aba14160c27ca26540b";

                // Resm√Æ modal ile provider olu≈ütur
                walletConnectProvider = await WC.EthereumProvider.init({
                    projectId,
                    showQrModal: true,
                    chains: [42220],          // Celo Mainnet
                    optionalChains: [44787],  // Celo Alfajores
                    rpcMap: {
                        42220: "https://forno.celo.org",
                        44787: "https://alfajores-forno.celo-testnet.org"
                    },
                    methods: [
                        "eth_sendTransaction",
                        "eth_signTransaction",
                        "eth_sign",
                        "personal_sign",
                        "eth_signTypedData",
                        "eth_signTypedData_v4",
                        "eth_requestAccounts"
                    ],
                    events: ["chainChanged", "accountsChanged", "disconnect"],
                    metadata: {
                        name: "Celo Engage Hub",
                        description: "Community engagement dApp on Celo",
                        url: "https://tebberen.github.io/celo-engage-hub/",
                        icons: ["https://raw.githubusercontent.com/celo-org/celo-brand/master/icon/128x128.png"]
                    },
                    themeMode: "light"
                });

                console.log("‚úÖ WalletConnect ba≈ülatƒ±ldƒ±, QR modal a√ßƒ±lƒ±yor...");
                await walletConnectProvider.enable(); // QR a√ßƒ±lƒ±r, baƒülantƒ± kurulunca resolve olur

                provider = new ethers.providers.Web3Provider(walletConnectProvider);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                
                document.getElementById('walletAddress').textContent =
                    `${userAddress.substring(0, 6)}...${userAddress.substring(userAddress.length - 4)}`;
                document.getElementById('walletInfo').classList.remove('hidden');
                document.getElementById('connectWalletBtn').style.display = 'none';
                isConnected = true;

                await checkCurrentNetwork();
                loadPlatformStats();
                loadUserProfile();
                closeWalletModal();

                // Eventler
                walletConnectProvider.on("accountsChanged", (accounts) => {
                    if (!accounts || accounts.length === 0) {
                        disconnectWallet();
                    } else {
                        location.reload();
                    }
                });
                
                walletConnectProvider.on("chainChanged", () => {
                    checkCurrentNetwork();
                    location.reload();
                });
                
                walletConnectProvider.on("disconnect", () => {
                    disconnectWallet();
                });

                return true;
            } catch (error) {
                console.error("WalletConnect v2 error:", error);
                alert("Baƒülantƒ± ba≈üarƒ±sƒ±z. L√ºtfen QR kodu tekrar deneyin.");
                closeWalletModal();
                return false;
            }
        }

        function connectWallet() {
            openWalletModal();
        }

        function disconnectWallet() {
            try {
                if (walletConnectProvider && walletConnectProvider.disconnect) {
                    walletConnectProvider.disconnect();
                }
            } catch (e) {}
            isConnected = false;
            provider = null;
            signer = null;
            userAddress = '';
            document.getElementById('walletInfo').classList.add('hidden');
            document.getElementById('connectWalletBtn').style.display = 'inline-block';
            document.getElementById('governanceSection').classList.add('hidden');
            document.getElementById('badgesSection').classList.add('hidden');
            document.getElementById('userProfileSection').classList.add('hidden');
            displaySupportLinks();
            const s2 = document.getElementById('step2');
            const s1 = document.getElementById('step1');
            if (s2 && s1) { s2.classList.add('hidden'); s1.classList.remove('hidden'); }
        }

        function openWalletModal() {
            document.getElementById('walletModal').classList.remove('hidden');
        }

        function closeWalletModal() {
            document.getElementById('walletModal').classList.add('hidden');
        }

        async function submitLink() {
            if (!isConnected) {
                const connected = await connectWalletMetaMask();
                if (!connected) return;
            }
            if (!hasSupported) {
                console.log("Please support at least one community member first!");
                return;
            }
            const isCorrectNetwork = await checkCurrentNetwork();
            if (!isCorrectNetwork) {
                console.log("Please switch to Celo network to submit your link");
                return;
            }
            const userLink = document.getElementById("userLinkInput").value.trim();
            if (!userLink) {
                console.log("Please enter your link first.");
                return;
            }
            if (!userLink.startsWith('http://') && !userLink.startsWith('https://')) {
                console.log("Please enter a valid URL starting with http:// or https://");
                return;
            }
            try {
                document.getElementById("submitLinkBtn").disabled = true;
                document.getElementById("submitLinkBtn").textContent = "‚è≥ Checking...";
                const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);
                const userProfileData = await contract.getUserProfile(userAddress);
                let tx;
                if (userProfileData.isActive) {
                    document.getElementById("submitLinkBtn").textContent = "‚è≥ Updating...";
                    tx = await contract.connect(signer).updateProfile("User", { gasLimit: 300000 });
                    console.log("üîÑ Update transaction sent:", tx.hash);
                } else {
                    document.getElementById("submitLinkBtn").textContent = "‚è≥ Registering...";
                    tx = await contract.connect(signer).registerUser("User", { gasLimit: 500000 });
                    console.log("üîÑ Register transaction sent:", tx.hash);
                }
                const receipt = await tx.wait();
                console.log("‚úÖ Transaction confirmed:", receipt);
                const newLinkData = {
                    link: userLink,
                    clickCount: 0,
                    timestamp: Date.now(),
                    submitter: userAddress
                };
                allCommunityLinks.unshift(newLinkData);
                saveLinksToStorage(allCommunityLinks);
                displaySupportLinks();
                document.getElementById("userLinkInput").value = "";
                hasSupported = false;
                document.getElementById('step2').classList.add('hidden');
                document.getElementById('step1').classList.remove('hidden');
            } catch (error) {
                console.error("‚ùå Submit error:", error);
            } finally {
                document.getElementById("submitLinkBtn").disabled = false;
                document.getElementById("submitLinkBtn").textContent = "‚úçÔ∏è Submit Link";
            }
        }

        document.getElementById("connectWalletBtn").addEventListener("click", connectWallet);
        document.getElementById("modalMetaMaskBtn").addEventListener("click", connectWalletMetaMask);
        document.getElementById("modalWalletConnectBtn").addEventListener("click", connectWalletWalletConnect);
        document.getElementById("closeWalletModalBtn").addEventListener("click", closeWalletModal);
        document.getElementById("submitLinkBtn").addEventListener("click", submitLink);
        document.getElementById("setupProfileBtn").addEventListener("click", setupUserProfile);
        document.getElementById("createProposalBtn").addEventListener("click", createProposal);
        document.getElementById("disconnectWalletBtn").addEventListener("click", disconnectWallet);

        if (window.ethereum) {
            window.ethereum.on('chainChanged', (chainId) => {
                console.log("Chain changed to:", chainId);
                currentChainId = parseInt(chainId, 16).toString();
                checkCurrentNetwork();
                if (isConnected) {
                    loadPlatformStats();
                    loadUserProfile();
                }
            });
            
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    disconnectWallet();
                } else if (isConnected) {
                    location.reload();
                }
            });
        }

        window.addEventListener('load', function() {
            displaySupportLinks();
        });

        window.handleCommunityLink = handleCommunityLink;
        window.voteProposal = voteProposal;
    </script>
</body>
</html>
